# JavaScript 실행 컨텍스트 & 스코프체인 & 클로저

## 실행 컨텍스트
* 자바스크립트가 실행될 때 생성되는 하나의 실행 단위
* 실행 가능한 코드를 형상화하고 구분하는 추상적인 개념
* 실행 가능한 자바스크립트 코드 블록이 실행되는 환경(콜스택과 유사)

``` javascript
console.log('global context');			// 1

function Context1() {
	console.log('Context1');				// 2
};

function Context2() {
	Context1();
	console.log('Context2');				// 3
};

Context2();						// 1, 2, 3의 순서로 출력된다
	
// 실행 컨텍스트 스택에는 전역 컨텍스트가 가장 먼저 실행된다
// 그 후 Context2가 호출될 때 실행 컨텍스트 스택에 Context2가 쌓이게 되고
// Context2내부에서 Context1이 호출될 때 Context1이 쌓이게 된다
```

## 실행 컨텍스트 생성 과정
1. 활성 객체 생성 (활성 객체 == 변수 객체)
	* 실행 컨텍스트가 생성되면 자바스크립트 엔진은 컨텍스트에서 실행에 필요한 여러가지 정보를 담을 객체를 생성(이것이 활성 객체)
	* 활성 객체는 사용할 매개변수나 사용자가 정의한 변수 및 객체를 저장하고, 새로 만들어진 컨텍스트로 엔진 내부에서 접근 가능하게 되어있다

2. aruments 객체 생성
	* 활성 객체는 argument 프로퍼티로  arguments 객체를 참조한다

3. 스코프 정보 생성
	* 컨텍스트 유효 범위를 나타내는 스코프 정보를 생성 (연결 리스트와 유사한 형식)
	* 현재 컨텍스트에서 특정 변수에 접근해야할 경우 이 리스트를 활용한다
	* 현재 컨텍스트의 변수뿐 아니라, 상위 실행 컨텍스트의 변수도 접근이 가능하다
	* 이 리스트를 스코프 체인이라고 한다(`[[scope]]`프로퍼티로 참조)

4. 변수 생성
	* 실행 컨텍스트 내부에서 사용되는 지역 변수의 생성이 이루어진다
	* 활성 객체가 변수 객체(생성되는 변수를 저장하는 객체)로 사용 (활성객체==변수객체)
	* 변수객체 안에서 호출된 함수 인자는 각각의 프로퍼티가 만들어지고 그 값이 할당된다. (인자가 넘겨지지 않았다면 undefined로 할당)
	* 변수나 내부함수를 단지 메모리에 생성하기만 한다 (변수나 함수에 해당하는 표현식이 실행되기 전까지는 초기화 되지않는다)
	* 표현식의 실행은 변수 객체 생성이 다 이루어진 후에 실행된다


5. this 바인딩
	* 	this 키워드를 사용하는 값이 할당

6. 코드 실행
	* 	실행 컨텍스트가 실행되고, 변수 객체가 만들어진 후에 코드에 있는 여러가지 표현식 실행이 이루어진다.
	* 	변수의 초기화 및 연산, 또 다른 함수 실행 등이 이루어진다
	
> 전역 실행 컨텍스트와 일반적인 실행 컨텍스트의 차이  
> 전역 객체는 arguments 객체가 없고, 전역 객체 하나만을 포함하는 스코프 체인이 있다.  
> 실행 컨텍스트가 형성되는 세가지 중 하나로서 전역 코드가 있는데, 이 전역 코드가 실행될 때 생성 되는 컨텍스트가 전역 실행 컨텍스트이다  
> 전역 실행 컨텍스트의 변수 객체가 전역 객체로 사용된다.(this 역시 전역 객체의 참조로 사용)  



## 스코프 체인
* 자바스크립트는 함수만이 유효 범위의 한 단위가 된다(for, if 문 등의 구문은 유효범위가 없다)
* 유효 범위를 나타내는 스코프가 `[[scope]] 프로퍼티`로 각 함수 객체 내에서 연결 리스트 형식으로 관리 되는데 이를 스코프 체인이라고 한다
* 스코프 체인 생성
	1. 각각의 함수는 `[[scope]] 프로퍼티`로 자신이 생성된 실행 컨텍스트의 스코프 체인을 참조한다
	2. 함수가 실행되는 순간 실행 컨텍스트가 만들어지고, 이 실행 컨텍스트는 실행된 함수의`[[scope]] 프로퍼티`를 기반을 새로운 스코프 체인을 만든다 (현재 실행되는 함수 객체의 `[[scope]] 프로퍼티`를 복사하고, 새롭게 생성된 변수 객체를 해당 체인의 제일 앞에 추가한다)

* **스코프 체인 = 현재 실행 컨텍스트의 변수 객체 + 상위 컨텍스트의 스코프 체인**


### 전역 실행 컨텍스트의 스코프 체인

* 전역 코드는 함수가 선언되지않아 함수 호출이 없고, 실행 가능한 코드들만 나열되어있다
* 코드를 실행하면 전역 실행 컨텍스트가 생성되고 변수객체가 만들어진다
* 전역 실행 컨텍스트 단하나만 실행되고있어 참조할 상위 컨텍스트가 없으므로 자신이 최상위에 위치하는 변수 객체이다.
* 따라서 이 변수객체의 스코프 체인은 자기 자신만을 가진다
``` javascript
var var1 = 1;
var var2 = 2;
console.log(var1);			// 1
console.log(var2);			// 2
```


### 함수를 호출한 경우 생성되는 실행 컨텍스트의 스코프 체인
* 전역 실행 컨텍스트가 생성되고 func()함수 객체가 만들어진다.
* 함수 객체가 생성될 때, 그 함수 객체의 `[[scope]]`는 현재 실행되는 컨텍스트의 변수객체에 있는 `[[scope]]`를 그대로 갖는다. 따라서 func() 함수 객체의 `[[scope]]`는 전역 변수객체가 된다
* 이때 func() 함수를 실행하면 새로운 컨텍스트가 만들어진다. 이 컨텍스트의 스코프 체인은 실행된 함수의 `[[scope]] 프로퍼티`를 그대로 복사한 후, 현재 생성된 변수 객체를 복사한 스코프 체인의 맨 앞에 추가한다.
``` javascript
var var1 = 1;
var var2 = 2;

function func() {
	var var1 = 10;
	var var2 = 20;
	console.log(var1);			// 10
	console.log(var2);			// 20
}

func();
console.log(var1);			// 1
console.log(var2);			// 2
```

### 식별자 인식
* 스코프 체인이 생성된 후 이 스코프 체인으로 식별자 인식이 이루어진다.
* 식별 자 인식은 스코프의 첫번째 변수 객체부터 시작
* 식별자와 대응되는 이름을 가진 프로퍼티가 있는지 확인
* 함수를 호출할 때 스코프 체인의 가장 앞에 있는 객체가 변수 객체 이므로, 이 변수 객체에 있는 공식인자, 내부함수, 지역 변수에 대응되는지 먼저 확인
* 객체에 대응되는 프로퍼티를 발견하지 못하면 계속해서 다음 객체로 이동하며 찾는다


### with 구문 (eval과 함께 사용하지 말아야 할 키워드)
* 스코프 체인을 사용자가 임의로 수정하는 키워드
* 자바스크립트 성능 때문에 사용하면 안된다!
* with== ‘pure javascript evil’




